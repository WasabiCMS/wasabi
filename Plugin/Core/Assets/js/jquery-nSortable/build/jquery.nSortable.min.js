/*!
 * jQuery Nested Sortable v0.0.1
 *
 * Copyright (c) 2013 Frank FÃ¶rster (http://frankfoerster.com)
 * Licensed under the MIT License
 */
!function(a){"use strict";var b=function(b,c){this.$el=a(b),this.settings=a.extend({},a.fn.nSortable.defaults,c),this.isDragging=!1,this.$li=null,this.$clone=null,this.$placeholder=null,this.startPosition={},this.startDepth=null,this.targetDepth=null,this.liOffset={},this.delta={x:0,y:0},this.placeholderHeight=null,this.placeholderDepth=null,this.$scrollParent=null,this._primaryEvents=[],this._secondaryEvents=[],this._results=[],this._buildEvents(),a.attachEvents(this._primaryEvents)};b.prototype={_buildEvents:function(){this._primaryEvents=[[this.$el,"li "+this.settings.containerElement+" "+this.settings.handle,[["mousedown",a.proxy(this._onMouseDown,this)],["mouseup",a.proxy(this._onMouseUp,this)]]]],this._secondaryEvents=[[a(window),{mousemove:a.proxy(this._onMouseMove,this)}]]},_onMouseDown:function(b){b.preventDefault(),this._initStart(b),a.attachEvents(this._secondaryEvents)},_onMouseUp:function(b){function c(){d.$clone.remove(),d.$clone=null,d.$li.insertBefore(d.$placeholder),d.$placeholder.remove(),d.$placeholder=null,d.$li.show(),d.$li=null,d.$scrollParent=null,d.isDragging=!1,d._trigger("nSortable-change",b)}var d=this;if(a.detachEvents(this._secondaryEvents),this.isDragging)if(this.settings.animateTarget){this.$clone.insertBefore(this.$placeholder);var e=this.$placeholder.offset();this.$clone.animate({top:e.top,left:e.left},parseInt(this.settings.animationLength),c)}else c()},_onMouseMove:function(b){this.isDragging||(this._initClone(),this._initPlaceholder(),this.$li.hide(),this.$scrollParent=this.$clone.scrollParent(),this.isDragging=!0),this._updateClonePosition(b),this._updateDelta(b),this._updateTargetDepth(),this.placeholderDepth=this.$placeholder.parentsUntil(this.$el,"ul").length,this.settings.scroll===!0&&this._scroll(b);var c=this.$placeholder.parent().find("> li").filter(function(){return"none"!==a(this).css("display")&&"absolute"!==a(this).css("position")}),d=c.index(this.$placeholder),e=d===c.length-1,f=d>0;!function(g){if(g._yIntersectsPlaceholder(b)){if(e&&g.targetDepth<g.placeholderDepth){var h=g.$placeholder.parent(),i=h.parent(),j=h.find("> li").filter(function(){return"none"!==a(this).css("display")&&!a(this).hasClass(g.settings.placeholder)&&"absolute"!==a(this).css("position")});return g.$placeholder.insertAfter(i),j.length||i.addClass(g.settings.noChildClass),void 0}if(f&&g.targetDepth>g.placeholderDepth){var k=a(c.get(d-1)),l=k.find("> ul");l.length||(l=a("<ul></ul>"),k.append(l)),l.append(g.$placeholder).parent().removeClass(g.settings.noChildClass)}}else{var m=g.$el.find("li").filter(function(){return a(this)[0]!==g.$li[0]&&"none"!==a(this).css("display")&&"absolute"!==a(this).css("position")&&!a(this).parents("li").filter(function(){return"absolute"===a(this).css("position")||a(this).is(g.$li)}).length&&!a(this).hasClass(g.settings.placeholder)}).find(g.settings.containerElement),n=null,o=null;if(m.each(function(){var c=a(this).position().top,d=c+a(this).outerHeight(),e=parseInt((c+d)/2);return b.pageY>=c&&b.pageY<e?(n=a(this).parent(),o="up",void 0):b.pageY>e&&b.pageY<=d?(n=a(this).parent(),o="down",void 0):void 0}),null===n)return;var p=n.parentsUntil(g.$el,"ul").length;if(g.targetDepth!==p)return;if(g.targetDepth===p){if("up"===o){if(n.prev().hasClass(g.settings.placeholder))return;return h=g.$placeholder.parent(),i=h.parent(),j=h.find("> li").filter(function(){return"none"!==a(this).css("display")&&!a(this).hasClass(g.settings.placeholder)&&"absolute"!==a(this).css("position")}),g.$placeholder.insertBefore(n),j.length||i.addClass(g.settings.noChildClass),void 0}if("down"===o){if("none"===n.next().css("display")&&n.next().next().hasClass(g.settings.placeholder))return;h=g.$placeholder.parent(),i=h.parent(),j=h.find("> li").filter(function(){return"none"!==a(this).css("display")&&!a(this).hasClass(g.settings.placeholder)&&"absolute"!==a(this).css("position")}),g.$placeholder.insertAfter(n),j.length||i.addClass(g.settings.noChildClass)}}}}(this),this.$el.find("ul").not(":has(li)").remove()},_initStart:function(b){this.$li=a(b.target).closest("li"),this.startPosition={x:b.pageX,y:b.pageY},this.startDepth=this.$li.parents("ul").length-1;var c=this.$li.offset();this.liOffset={x:this.startPosition.x-c.left,y:this.startPosition.y-c.top}},_initClone:function(){this.$clone=this.$li.clone(),this.$clone.css({display:"list-item",width:this.$li.outerWidth(),height:this.$li.outerHeight(),position:"absolute",zIndex:1e4,opacity:this.settings.opacity}),this.$li.parent().append(this.$clone)},_initPlaceholder:function(){this.placeholderHeight=this.$li.innerHeight(),this.$placeholder=a("<li></li>"),this.$placeholder.addClass(this.settings.placeholder).css({height:this.placeholderHeight}),this.$li.after(this.$placeholder)},_updateClonePosition:function(a){this.$clone.css({left:a.pageX-this.liOffset.x,top:a.pageY-this.liOffset.y})},_updateDelta:function(a){this.delta.x=-(this.startPosition.x-a.pageX),this.delta.y=this.startPosition.y-a.pageY},_updateTargetDepth:function(){var a=parseInt(this.delta.x/this.settings.tabWidth),b=this.startDepth+a;b=Math.max(b,0),b=Math.min(b,this.settings.maxDepth),this.targetDepth=b},_scroll:function(b){var c=this.$scrollParent[0],d=this.$scrollParent.offset();if(c!=document&&"HTML"!=c.tagName)d.top+c.offsetHeight-b.pageY<this.settings.scrollSensitivity?c.scrollTop=c.scrollTop+this.settings.scrollSpeed:b.pageY-d.top<this.settings.scrollSensitivity&&(c.scrollTop=c.scrollTop-this.settings.scrollSpeed),d.left+c.offsetWidth-b.pageX<this.settings.scrollSensitivity?c.scrollLeft=c.scrollLeft+this.settings.scrollSpeed:b.pageX-d.left<this.settings.scrollSensitivity&&(c.scrollLeft=c.scrollLeft-this.settings.scrollSpeed);else{var e=a(document),f=a(window);b.pageY-e.scrollTop()<this.settings.scrollSensitivity?e.scrollTop(e.scrollTop()-this.settings.scrollSpeed):f.height()-(b.pageY-e.scrollTop())<this.settings.scrollSensitivity&&e.scrollTop(e.scrollTop()+this.settings.scrollSpeed),b.pageX-e.scrollLeft()<this.settings.scrollSensitivity?e.scrollLeft(e.scrollLeft()-this.settings.scrollSpeed):f.width()-(b.pageX-e.scrollLeft())<this.settings.scrollSensitivity&&e.scrollLeft(e.scrollLeft()+this.settings.scrollSpeed)}},_yIntersectsPlaceholder:function(a){var b=this.$placeholder.offset().top,c=b+this.placeholderHeight;return a.pageY>=b&&a.pageY<=c},_trigger:function(b,c){this.$el.trigger(b,{event:c,toArray:a.proxy(this.toArray,this),serialize:a.proxy(this.serialize,this)})},_recursiveArray:function(b,c,d){var e,f,g=this,h=d+1,i=b.find("> ul > li"),j={};return i.length&&(c++,i.each(function(){h=g._recursiveArray(a(this),c,h)}),c--),e=b.attr(g.settings.dataAttribute),f=1===c?0:b.parent().parent().attr(g.settings.dataAttribute),e&&(j={id:e,parent_id:f,depth:c},j[this.settings.leftKey]=d,j[this.settings.rightKey]=h,this._results.push(j)),d=h+1},serialize:function(){for(var a=this.toArray(),b=[],c=0,d=a.length;d>c;c++){var e=a[c],f=this.settings.serializeKey+"["+c+"]";for(var g in e)b.push(f+"["+g+"]="+e[g])}return b.join("&")},toArray:function(){var b=1,c=this;return this._results=[],this.$el.children("li").each(function(){b=c._recursiveArray(a(this),1,b)}),this._results=this._results.sort(function(a,b){return a.left-b.left}),this._results}},a.fn.nSortable=function(c){if(!c||"object"==typeof c)return this.each(function(){a(this).data("nSortable")||a(this).data("nSortable",new b(this,c))});if("string"==typeof c&&"_"!==c.charAt(0)){var d=this.data("nSortable");if(!d)throw new Error("nSortable is not initialized on this DOM element.");if(d&&d[c])return d[c].apply(d,Array.prototype.slice.apply(arguments,[1]))}throw new Error('"'+c+'" is no valid api method.')},a.fn.nSortable.defaults={handle:"div",tabWidth:20,containerElement:"> div",opacity:.6,placeholder:"placeholder",noChildClass:"no-children",dataAttribute:"data-node-id",maxDepth:1/0,animateTarget:!0,animationLength:300,scroll:!0,scrollSensitivity:20,scrollSpeed:20,serializeKey:"nodes",leftKey:"left",rightKey:"right"}}(jQuery);