/*!
 * jQuery Multi Fileupload v0.0.1
 *
 * Copyright (c) 2013 Frank FÃ¶rster (http://frankfoerster.com)
 * Licensed under the MIT License
 */
!function(a,b,c,d){var e={};e.fileInput=!(new RegExp("(Android (1\\.[0156]|2\\.[01]))|(Windows Phone (OS 7|8\\.0))|(XBLWP)|(ZuneWP)|(WPDesktop)|(w(eb)?OSBrowser)|(webOS)|(Kindle/(1\\.0|2\\.[05]|3\\.0))").test(b.navigator.userAgent)||a('<input type="file">').prop("disabled")),e.xhrFileUpload=!(!b.XMLHttpRequestUpload||!b.FileReader),e.fileReader=!!b.FileReader,e.xhrFormDataFileUpload=!!b.FormData;var f=function(){this.timestamp=Date.now?Date.now():(new Date).getTime(),this.loaded=0,this.bitrate=0};f.prototype.getBitrate=function(a,b,c){var d=a-this.timestamp;return(!this.bitrate||!c||d>c)&&(this.bitrate=8*(b-this.loaded)*(1e3/d),this.loaded=b,this.timestamp=a),this.bitrate};var g=function(b,c){if(this.$el=a(b),this.options=a.extend({},a.fn.multifileupload.defaults,c),this.$input=this.$el.is("input[type=file]")?this.$el:this.$el.find("input[type=file]").first(),this.options.url===!1)throw new Error("options.url is not set.");this.$uploadAllBtn=this.$el.find(this.options.uploadAllBtn),this.$cancelAllBtn=this.$el.find(this.options.cancelAllBtn),this.uploadInProgress=!1,this.uploadQueue=[],this.uploading=a.Deferred(),this.fileSets={},this.jqXHR=d,this.progress={},this.bitRateTimer=d,this.init()};g.prototype=function(){function b(){K=[[this.$input,{change:a.proxy(h,this)}]],this.$uploadAllBtn.length>0&&K.push([this.$uploadAllBtn,{click:a.proxy(q,this)}]),this.$cancelAllBtn.length>0&&K.push([this.$cancelAllBtn,{click:a.proxy(r,this)}])}function c(){return!this.options.forceIframeTransport&&(!this.options.multipart&&e.xhrFileUpload||e.xhrFormDataFileUpload)}function h(b){b.preventDefault(),b.stopPropagation();var e,f,g,h,m={errors:[],files:[],mfu:this,validates:!0,size:!1,$context:d,$uploadBtn:d,$cancelBtn:d,$removeBtn:d};if(e=b.target.files!==d?b.target.files:[{name:a(b.target).val().replace(/^.*\\/,"")}],i.call(this),c.call(this))for(g=0,h=e.length;h>g;g++)f=a.extend({},m,{id:"fs_"+N++,fileInput:a(b.target),files:[],errors:[]}),e[g].errors=[],e[g].ext=e[g].name.split(".").pop().toLowerCase(),e[g].validates=!0,l.call(this,e[g]),f.size=e[g].size!==d?e[g].size:d,f.files.push(e[g]),j.call(this,f);else{for(f=a.extend({},m,{id:"fs_"+N++,fileInput:a(b.target),files:[],errors:[]}),g=0,h=e.length;h>g;g++){var n=e[g];n.errors=[],n.ext=n.name.split(".").pop().toLowerCase(),n.validates=!0,l.call(this,n),f.size!==d&&(n.size!==d?f.size+=n.size:f.size=d),f.files.push(n)}j.call(this,f)}!this.uploadInProgress&&k.call(this)>0&&H(this.$uploadAllBtn)}function i(){var a=this.$input.clone(!0);a.wrap("<form>").closest("form").get(0).reset(),a.unwrap(),this.$input.replaceWith(this.$input=a)}function j(b){if(m.call(this,b),this.$el.trigger("add.mfu",[b]),b.$context===d)throw new Error('fileSet.$context is not set on "mfu.add" event.');if(b.$uploadBtn!==d&&(b.validates||I(b.$uploadBtn),b.$uploadBtn.on("click",a.proxy(s,this,b))),b.$cancelBtn!==d&&(I(b.$cancelBtn),b.$cancelBtn.on("click",a.proxy(t,this,b))),b.$removeBtn!==d&&b.$removeBtn.on("click",a.proxy(u,this,b)),b.validates){this.fileSets[b.id]=b;for(var c=0,e=b.files.length;e>c;c++)b.files[c].fileSet=b,o.call(this,b.files[c]).always(a.proxy(p,this,b.files[c]))}}function k(){return a.map(this.fileSets,function(a,b){return b}).length}function l(b){-1===a.inArray("*",this.options.extensions)&&-1===a.inArray(b.ext,this.options.extensions)&&(b.validates=!1,b.errors.push(J(this.options.messages.fileExtNotAllowed,[b.ext]))),b.type!==d&&-1===a.inArray("*",this.options.mimeTypes)&&-1===a.inArray(b.type,this.options.mimeTypes)&&(b.validates=!1,b.errors.push(J(this.options.messages.mimeTypeNotAllowed,[b.type]))),b.size!==d&&(b.size<this.options.minFileSize&&(b.validates=!1,b.errors.push(J(this.options.messages.fileTooSmall,[b.name,this.bytesToHuman(this.options.minFileSize)]))),b.size>this.options.maxFileSize&&(b.validates=!1,b.errors.push(J(this.options.messages.fileTooBig,[b.name,this.bytesToHuman(this.options.maxFileSize)]))))}function m(a){if(a.files.length>this.options.maxFilesPerUpload&&(a.validates=!1,a.errors.push(J(this.options.messages.tooManyFiles,[this.options.maxFilesPerUpload]))),a.size!==d&&a.size>this.options.maxUploadSize&&(a.validates=!1,a.errors.push(J(this.options.messages.uploadSizeExceeded,[this.bytesToHuman(this.options.maxUploadSize)]))),a.validates)for(var b=0,c=a.files.length;c>b;b++)if(!a.files[b].validates){a.validates=!1;break}}function n(b){var c=a.Deferred(),e=b.processingQueue.shift(),f=this;c.promise().then(function(){b.processingQueue.length>=1&&n.call(f,b),b.processing.resolve()},function(){b.processing!==d&&b.processing.reject()});try{O[e].call(this,c,b)}catch(g){b.processing.reject(g)}}function o(b){return a.extend(b,{processing:a.Deferred(),processingQueue:this.options.processingQueue.slice()}),n.call(this,b),b.processing.promise()}function p(a){delete a.processing,delete a.processingQueue,this.$el.trigger("processed.mfu",[a])}function q(a){if(a.preventDefault(),a.stopPropagation(),!this.$uploadAllBtn.hasClass("disabled")){I(this.$uploadAllBtn);for(var b=0;N>b;b++){var c="fs_"+b;this.fileSets.hasOwnProperty(c)&&(this.uploadQueue.push(this.fileSets[c]),I(this.fileSets[c].$uploadBtn,this.fileSets[c].$removeBtn),H(this.fileSets[c].$cancelBtn))}H(this.$cancelAllBtn),C.call(this)}}function r(a){a.preventDefault(),a.stopPropagation(),this.$cancelAllBtn.hasClass("disabled")||(I(this.$cancelAllBtn),this.uploadQueue=[],this.jqXHR!==d&&this.jqXHR.abort())}function s(a){a.$uploadBtn.hasClass("disabled")||(I(this.$uploadAllBtn,a.$uploadBtn,a.$removeBtn),H(a.$cancelBtn,this.$cancelAllBtn),this.uploadQueue.push(a),C.call(this))}function t(a){a.$cancelBtn.hasClass("disabled")||(I(a.$cancelBtn),H(a.$uploadBtn,a.$removeBtn),this.jqXHR!==d&&this.jqXHR.abort(),this.$el.trigger("cancel-local.mfu",[a]))}function u(a){a.$removeBtn.hasClass("disabled")||(I(a.$removeBtn,a.$cancelBtn,a.$uploadBtn),this.fileSets.hasOwnProperty(a.id)&&delete this.fileSets[a.id],this.$el.trigger("remove-local.mfu",[a]))}function v(a){this.progress={minLoaded:0,bitrate:0,time:0,percent:0,loaded:0,total:F.call(this,a),filesLoaded:0,filesTotal:G.call(this,a)},this.$el.trigger("start.mfu",[this]),this.$el.trigger("progress.mfu",[this.progress,this])}function w(b){b&&(this.progress.loaded+=b.loaded-M,M=b.loaded),this.progress.percent=this.progress.total!==d?Math.ceil(100*(this.progress.loaded/this.progress.total)):Math.ceil(100*(this.progress.filesLoaded/this.progress.filesTotal)),this.bitRateTimer!==d&&(this.progress.bitrate=this.bitRateTimer.getBitrate(a.now(),M,this.options.bitrateInterval)),this.$el.trigger("progress.mfu",[this.progress,this])}function x(){this.uploadInProgress=!1,I(this.$cancelAllBtn),k.call(this)>0?H(this.$uploadAllBtn):I(this.$uploadAllBtn),this.$el.trigger("complete.mfu",[this])}function y(a){c.call(this)&&(this.bitRateTimer=new f),a.size!==d&&(this.progress.minLoaded+=a.size),M=0}function z(a,b){if(a.lengthComputable){var c=Math.ceil(100*(a.loaded/a.total));this.$el.trigger("progress-local.mfu",[c,b]),w.call(this,a)}}function A(a,b){console.log(a);var c=[];if(a){if(a.status===d)alert("Server has to respond with a json response, containing a status key.");else if("error"===a.status&&a.errors!==d&&a.errors.length>0)for(var e=0,f=a.errors.length;f>e;e++){var g=a.errors[e];c.push(J(g.message,g.context))}}else alert("Something went wrong.");I(b.$cancelBtn),H(b.$removeBtn),delete this.fileSets[b.id],this.$el.trigger("error.mfu",[c,b])}function B(a,b){this.progress.loaded=this.progress.minLoaded,this.progress.filesLoaded+=b.files.length,this.fileSets.hasOwnProperty(b.id)&&delete this.fileSets[b.id],w.call(this),I(b.$cancelBtn,b.$removeBtn),this.$el.trigger("complete-local.mfu",[b])}function C(){if(0!==this.uploadQueue.length){var b=this,c=function(){return b.uploadInProgress||(b.uploadInProgress=!0,v.call(b,b.uploadQueue)),function a(){var c=b.uploadQueue.shift();return c&&D.call(b,c).then(a)}()};this.uploading.then(c).done(a.proxy(x,this)),this.uploading.resolve()}}function D(b){var e=this,f="json",g=c.call(this);return g||(f="mfuiframe "+f),a.ajax({url:this.options.url,type:"post",contentType:!1,processData:!1,cache:!1,dataType:f,fileInput:b.fileInput,beforeSend:function(a,c){g&&E.call(e,a,c,b),y.call(e,b),e.jqXHR=a},success:function(a){a&&a.status!==d&&"error"!==a.status?B.call(e,a,b):A.call(e,a,b)},error:function(a,b,c){console.log(b),console.log(c)},complete:function(){e.jqXHR=d}})}function E(b,c,e){var f=this,g=new FormData,h=this.$input.attr("name"),i=this.options.paramName!==d&&""!==this.options.paramName?this.options.paramName:h!==d&&""!==h?h:"files[]";g.append(i,e.files[0]),c.data=g,c.xhr=function(){var b=a.ajaxSettings.xhr();return b.upload&&b.upload.addEventListener("progress",function(a){z.call(f,a,e)},!1),b}}function F(a){for(var b=0,c=0,e=a.length;e>c;c++){if(a[c].size===d){b=d;break}b+=a[c].size}return b}function G(a){for(var b=0,c=0,d=a.length;d>c;c++)b+=a[c].files.length;return b}function H(){for(var a=0,b=arguments.length;b>a;a++)arguments[a]&&arguments[a].length>0&&arguments[a].removeClass("disabled")}function I(){for(var a=0,b=arguments.length;b>a;a++)arguments[a]&&arguments[a].length>0&&arguments[a].addClass("disabled")}function J(b,c){return c&&a.each(c,function(a,c){b=b.replace("{"+a+"}",c)}),b}var K=[],L=["jpg","jpeg","png","gif","bmp"],M=0,N=0,O=function(){function b(a,b){var c=new FileReader;c.onload=function(a){var c=new Image;c.onload=function(){b({width:this.width,height:this.height,imgObj:c})},c.src=a.target.result},c.readAsDataURL(a)}function c(a,b){var c=new FileReader;c.onload=function(a){b(a.target.result)},c.readAsDataURL(a)}function d(b,c){var d,e=this.options.previewImageWidth,f=this.options.previewImageHeight,g=b.width/b.height,h=e/f;d=h>g?b.width/e:b.height/f;var i=Math.ceil(b.width/d),j=Math.ceil(b.height/d),k=Math.ceil((i-e)/2),l=Math.ceil((j-f)/2),m=a("<canvas/>").attr({width:i,height:j});m[0].getContext("2d").drawImage(b.imgObj,0,0,i,j);var n=new Image;n.onload=function(){c.getContext("2d").drawImage(n,k,l,e,f,0,0,e,f)},n.src=m[0].toDataURL()}return{image:function(c,f){if(!e.fileReader||-1===a.inArray(f.ext,L)||f.size>this.options.maxPreviewImageSize)return c.resolve();var g=this;return b.call(this,f,function(b){return f.img=b,f.$canvas=a("<canvas/>").attr({width:g.options.previewImageWidth,height:g.options.previewImageHeight}),d.call(g,f.img,f.$canvas[0]),c.reject()}),c.promise()},audio:function(b,d){var f=a("<audio/>");return!e.fileReader||!f[0].canPlayType||!f[0].canPlayType(d.type)||d.size>this.options.maxPreviewAudioSize?b.resolve():(d.$audio=f.css("width",this.options.previewImageWidth),c.call(this,d,function(a){return d.$audio[0].src=a,d.$audio[0].controls=!0,b.reject()}),b.promise())},video:function(b,d){var f=a("<video/>");if(!e.fileReader||!f[0].canPlayType||!f[0].canPlayType(d.type)||d.size>this.options.maxPreviewVideoSize)return b.resolve();var g=this;return d.$video=f,c.call(this,d,function(a){return d.$video[0].src=a,d.$video[0].controls=!0,d.$video[0].width=g.options.previewImageWidth,b.reject()}),b.promise()}}}();return{constructor:g,init:function(){b.call(this),a.attachEvents(K)},bytesToHuman:function(a,b){if("number"!=typeof a)return"";var c=1024,d=1024*c,e=1024*d;return a>=0&&c>a?a+"B":a>=c&&d>a?(a/c).toFixed(b)+" KB":a>=d&&e>a?(a/d).toFixed(b)+" MB":a>=e?(a/e).toFixed(b)+" GB":a+" B"},bitRateToHuman:function(a,b){if("number"!=typeof a)return"";var c=1e3,d=1e3*c,e=1e3*d;return a>=0&&c>a?a+"bit/s":a>=c&&d>a?(a/c).toFixed(b)+" Kbit/s":a>=d&&e>a?(a/d).toFixed(b)+" Mbit/s":a>=e?(a/e).toFixed(b)+" Gbit/s":a+" bit/s"}}}();var h=0;a.ajaxTransport("mfuiframe",function(b){function e(){j.unbind("load").bind("load",f),k.prop("target",j.prop("name")).prop("action",b.url).prop("method",b.type),b.fileInput!==d&&b.fileInput.length>0&&k.append(b.fileInput).prop("enctype","multipart/form-data").prop("encoding","multipart/form-data"),k.submit()}function f(){var b;try{if(b=j.contents(),!b.length||!b[0].firstChild)throw new Error}catch(c){b=d}m(200,"success",{mfuiframe:b}),a('<iframe src="javascript:false"/>').appendTo(k),setTimeout(function(){j.remove(),k.remove()},0)}function g(d,f){k=a('<form style="display: none;"/>'),k.attr("accept-charset",b.formAcceptCharset),l=/\?/.test(b.url)?"&":"?",b.url=b.url+l+"_method=PUT",m=f,h++,j=a('<iframe src="javascript:false;" name="mfu-iframe-transport-'+h+'"/>'),j.bind("load",e),k.appendTo(c.body),j.appendTo(c.body)}function i(){j.length>0&&(j.unbind("load").prop("src","javascript:false;"),j.remove()),k.length>0&&k.remove()}if(!b.async)return{};var j,k,l,m;return{send:g,abort:i}}),a.ajaxSetup({converters:{"mfuiframe json":function(b){return b&&a.parseJSON(a(b[0].body).text())}}}),a.fn.multifileupload=function(b){if(!b||"object"==typeof b)return this.each(function(){a(this).data("multifileupload")||a(this).data("multifileupload",new g(this,b))});if("string"==typeof b&&"_"!==b.charAt(0)){var c=this.data("multifileupload");if(!c)throw new Error("multifileupload is not initialized on this DOM element.");if(c&&c[b])return c[b].apply(c,Array.prototype.slice.apply(arguments,[1]))}throw new Error('"'+b+'" is no valid api method.')},a.fn.multifileupload.defaults={url:!1,dropZone:a(c),pasteZone:a(c),paramName:d,forceIframeTransport:!1,bitrateInterval:500,autoUpload:!1,extensions:["*"],mimeTypes:["*"],minFileSize:1,maxFileSize:5242880,maxFilesPerUpload:20,maxUploadSize:104857600,previewImageWidth:120,previewImageHeight:120,maxPreviewImageSize:5242880,maxPreviewAudioSize:15728640,maxPreviewVideoSize:524288e3,processingQueue:["image","audio","video"],uploadAllBtn:!1,cancelAllBtn:!1,messages:{fileExtNotAllowed:'The file extension ".{0}" is not allowed.',mimeTypeNotAllowed:'The mimetype "{0}" is not allowed.',fileTooSmall:"File {0} is too small. (min: {1})",fileTooBig:"File {0} is too big. (max: {1})",tooManyFiles:"You selected too many files in one go. (max: {0} Files)",uploadSizeExceeded:"Your selected files exceed the maximum upload limit. (max: {0})"}}}(jQuery,window,document);