define(["jquery","common/views/BaseView","hbs!common/templates/Modal","common/util/eventify"],function(t,i,o,s){var e=t("body"),a=t(document),n=t(window),l={width:400,offsetTop:200,opacity:.6,padding:20,cssClasses:{backdrop:"modal-backdrop",scrollable:"modal-scrollable",container:"modal-container",modalHeader:"modal-header",modalBody:"modal-body",modalFooter:"modal-footer",confirmFooter:"modal-confirm"},confirmYes:"Yes",confirmNo:"No"};return i.extend({$backdrop:null,$container:null,$closeButtons:null,$modal:null,$notify:null,$scrollable:null,$submitButtons:null,events:{click:"openModal"},isConfirmModal:!1,isOpened:!1,method:null,modalSuccessEvent:null,options:{},initialize:function(i){this.options=t.extend({},l,i)},initModalOptions:function(){if(this.method=this.$el.attr("data-modal-method")||"post",this.isAjax="1"===this.$el.attr("data-modal-ajax")||"true"===this.$el.attr("data-modal-ajax"),this.isAjax){var i=this.$el.attr("data-modal-notify");this.$notify=void 0!==i?t(i):a,this.modalSuccessEvent=this.$el.attr("data-modal-event")||"modal:success"}},createTemplateOptions:function(){var i,o,s={};return s.modalHeader=this.$el.attr("data-modal-title"),s.hasHeader=void 0!==s.modalHeader,s.modalBody=this.$el.attr("data-modal-body"),s.hasBody=void 0!==s.modalBody,s.hasBody||(o=t(this.$el.attr("data-modal-target")),i=o.length>0,i&&(s.modalBody=o.html(),s.hasBody=!0)),s.isConfirmModal="confirm"===this.$el.attr("data-toggle"),s.isConfirmModal?s.hasFooter=!0:(s.modalFooter=this.$el.attr("data-modal-footer"),s.hasFooter=void 0!==s.modalFooter),s.action=this.$el.attr("data-modal-action")||this.$el.attr("href")||!1,s.method=this.method,s.cssClasses=this.options.cssClasses,s.confirmYes=this.options.confirmYes,s.confirmNo=this.options.confirmNo,s},initModalElements:function(){this.$modal=t(o(this.createTemplateOptions())),this.$backdrop=this.$modal.find("."+this.options.cssClasses.backdrop),this.$backdrop.css({opacity:this.options.opacity}),this.$scrollable=this.$modal.find("."+this.options.cssClasses.scrollable),this.$container=this.$modal.find("."+this.options.cssClasses.container),this.$container.css({width:this.options.width,position:"fixed",left:-99999,top:this.options.offsetTop,opacity:0,zIndex:1e4}),this.$closeButtons=this.$modal.find('[data-dismiss="modal"]'),this.$submitButtons=this.$modal.find('button[type="submit"]')},updatePosition:function(){var t=this.$container.outerHeight(),i=this.$container.offset().top-this.$scrollable.offset().top,o=this.$scrollable.height(),s=o-t-i<this.options.offsetTop;e.toggleClass("page-overflow",n.height()<a.height()),this.$container.css(s?t+2*this.options.padding<=o?{top:"50%",marginTop:-t/2}:{top:this.options.padding,marginTop:0}:{top:this.options.offsetTop,marginTop:0}),this.$container.css({position:"absolute",marginLeft:-this.options.width/2,left:"50%"})},resetDOM:function(){e.removeClass("modal-open").removeClass("page-overflow"),this.$modal=null,this.$container=null,this.$scrollable=null,this.$backdrop=null},onResize:function(){this.isOpened&&this.updatePosition()},submit:function(i){var o=t(i.target),s=this;void 0===o.attr("disabled")&&(this.isAjax?(i.preventDefault(),o.prop("disabled",!0),this.$notify.trigger("modal:beforeAjax"),t.ajax({type:this.method,url:this.action,cache:!1,success:function(t){s.closeModal(),s.$notify.trigger(s.modalSuccessEvent,t)}})):this.closeModal())},openModal:function(t){t&&t.preventDefault(),this.isOpened||(this.isOpened=!0,this.initModalOptions(),this.initModalElements(),e.addClass("modal-open").append(this.$modal),this.updatePosition(),this.$container.hide().css("opacity",1).fadeIn(),this.listenTo(s(n),"resize",_.bind(this.onResize,this)),this.listenTo(s(this.$closeButtons),"click",_.bind(this.closeModal,this)),this.listenTo(s(this.$scrollable),"click",_.bind(this.closeModal,this)),this.listenTo(s(this.$submitButtons),"click",_.bind(this.submit,this)))},closeModal:function(i){if(i){if(i.target!==i.currentTarget)return;i.preventDefault()}this.stopListening(s(n),"resize",_.bind(this.onResize,this)),this.stopListening(s(this.$closeButtons),"click",_.bind(this.closeModal,this)),this.stopListening(s(this.$scrollable),"click",_.bind(this.closeModal,this)),this.stopListening(s(this.$submitButtons),"click",_.bind(this.submit,this)),t.when.apply(null,[this.$container.fadeOut(200),this.$backdrop.fadeOut(200)]).then(t.proxy(function(){this.$modal.remove(),this.resetDOM(),this.isOpened=!1},this))}})});