define(["jquery","Underscore","Backbone","Spinner"],function(e,t,n,o){return n.View.extend({$blockBackdrop:e('<div class="block-backdrop"></div>'),numberOfBlocks:0,spinner:null,delegateEvents:function(e){var o,s,i;n.View.prototype.delegateEvents.call(this,e),this.globalEvents=this.globalEvents||{},"function"==typeof this.globalEvents&&(this.globalEvents=this.globalEvents()),i=[];for(o in this.globalEvents)this.globalEvents.hasOwnProperty(o)&&(s=this.globalEvents[o],i.push(this.eventBus.bind(o,t.bind(this[s],this))));return i},blockThis:function(t){this.numberOfBlocks++;var n=this.$el.offset(),s=this.$el.css("borderLeftWidth"),i=this.$el.css("borderTopWidth"),l=this.$el.innerWidth()+(t.deltaWidth||0),h=this.$el.innerHeight()+(t.deltaHeight||0);""!==s&&(s=parseInt(s.split("px")[0]),n.left+=s),""!==i&&(i=parseInt(i.split("px")[0]),n.top+=i),this.$blockBackdrop.css({position:"absolute",top:n.top,left:n.left,width:l,height:h,backgroundColor:t.backgroundColor||"transparent",opacity:t.opacity||.6,cursor:t.cursor||"wait",zIndex:t.zIndex||9997}).hide().appendTo(e("body")),this.$blockBackdrop.fadeIn(100,e.proxy(function(){this.delegateEvents({mousedown:"handleBlockedEvent",mouseup:"handleBlockedEvent",keydown:"handleBlockedEvent",keypress:"handleBlockedEvent",keyup:"handleBlockedEvent",touchstart:"handleBlockedEvent",touchend:"handleBlockedEvent",touchmove:"handleBlockedEvent"}),this.spinner=this.spinner||new o(t.spinner||!1),this.spinner.spin(this.$blockBackdrop.get(0))},this))},unblockThis:function(e){this.numberOfBlocks>=1&&this.numberOfBlocks--,0===this.numberOfBlocks&&(e=e||function(){},this.spinner.stop(),this.$blockBackdrop.remove(),this.delegateEvents(),"function"==typeof e&&e.call(this))},handleBlockedEvent:function(e){e.preventDefault(),e.stopPropagation()}})});