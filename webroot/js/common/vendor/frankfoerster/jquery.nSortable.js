/*!
 * jQuery Nested Sortable v0.0.1
 *
 * Copyright (c) 2013 Frank FÃ¶rster (http://frankfoerster.com)
 * Licensed under the MIT License
 */

!function(t,e,s){var i=function(e,s){this.$el=t(e),this.settings=t.extend({},t.fn.nSortable.defaults,s),this.isDragging=!1,this.$li=null,this.$clone=null,this.$placeholder=null,this.startPosition={},this.startDepth=null,this.targetDepth=null,this.liOffset={},this.delta={x:0,y:0},this.childLevels=0,this.placeholderHeight=null,this.placeholderDepth=null,this.$scrollParent=null,this._primaryEvents=[],this._secondaryEvents=[],this._results=[],this._buildEvents(),t.attachEvents(this._primaryEvents)};i.prototype={_buildEvents:function(){this._primaryEvents=[[this.$el,"li "+this.settings.containerElement+" "+this.settings.handle,[["mousedown",t.proxy(this._onMouseDown,this)],["mouseup",t.proxy(this._onMouseUp,this)]]]],this._secondaryEvents=[[t(e),{mousemove:t.proxy(this._onMouseMove,this)}]]},_onMouseDown:function(e){e.preventDefault(),this._initStart(e),t.attachEvents(this._secondaryEvents)},_onMouseUp:function(e){function s(){i.$clone.remove(),i.$clone=null,i.$li.insertBefore(i.$placeholder),i.$placeholder.remove(),i.$placeholder=null,i.$li.show(),i.$li=null,i.$scrollParent=null,i.childLevels=0,i.isDragging=!1}var i=this;if(t.detachEvents(this._secondaryEvents),this.isDragging)if(i._trigger("nSortable-change",e),this.settings.animateTarget){this.$clone.insertBefore(this.$placeholder);var l=this.$placeholder.offset();this.$clone.animate({top:l.top,left:l.left},parseInt(this.settings.animationLength),s)}else s()},_onMouseMove:function(e){this.isDragging||(this._initClone(),this._initPlaceholder(),this.$li.hide(),this.$scrollParent=this.$clone.scrollParent(),this.isDragging=!0),this._updateClonePosition(e),this._updateDelta(e),this._updateTargetDepth(),this.placeholderDepth=this.$placeholder.parentsUntil(this.$el,"ul").length,this.settings.scroll===!0&&this._scroll(e);var s=this.$placeholder.parent().find("> li").filter(function(){return"none"!==t(this).css("display")&&"absolute"!==t(this).css("position")}),i=s.index(this.$placeholder),l=i===s.length-1,n=i>0;!function(r){if(r._yIntersectsPlaceholder(e)){if(l&&r.targetDepth<r.placeholderDepth){var h=r.$placeholder.parent(),o=h.parent(),a=h.find("> li").filter(function(){return"none"!==t(this).css("display")&&!t(this).hasClass(r.settings.placeholder)&&"absolute"!==t(this).css("position")});return r.$placeholder.insertAfter(o),void(a.length||o.addClass(r.settings.noChildClass))}if(n&&r.targetDepth>r.placeholderDepth){var c=t(s.get(i-1)),p=c.find("> ul");p.length||(p=t("<ul></ul>"),c.append(p)),p.append(r.$placeholder).parent().removeClass(r.settings.noChildClass)}}else{var d=r.$el.find("li").filter(function(){return t(this)[0]!==r.$li[0]&&"none"!==t(this).css("display")&&"absolute"!==t(this).css("position")&&!t(this).parents("li").filter(function(){return"absolute"===t(this).css("position")||t(this).is(r.$li)}).length&&!t(this).hasClass(r.settings.placeholder)}).find(r.settings.containerElement),g=null,u=null;if(d.each(function(){var s=t(this).position().top,i=s+t(this).outerHeight(),l=parseInt((s+i)/2);return e.pageY>=s&&e.pageY<l?(g=t(this).parent(),void(u="up")):e.pageY>l&&e.pageY<=i?(g=t(this).parent(),void(u="down")):void 0}),null===g)return;var f=g.parentsUntil(r.$el,"ul").length;if(r.targetDepth!==f)return;if(r.targetDepth===f){if("up"===u){if(g.prev().hasClass(r.settings.placeholder))return;return h=r.$placeholder.parent(),o=h.parent(),a=h.find("> li").filter(function(){return"none"!==t(this).css("display")&&!t(this).hasClass(r.settings.placeholder)&&"absolute"!==t(this).css("position")}),r.$placeholder.insertBefore(g),void(a.length||o.addClass(r.settings.noChildClass))}if("down"===u){if("none"===g.next().css("display")&&g.next().next().hasClass(r.settings.placeholder))return;h=r.$placeholder.parent(),o=h.parent(),a=h.find("> li").filter(function(){return"none"!==t(this).css("display")&&!t(this).hasClass(r.settings.placeholder)&&"absolute"!==t(this).css("position")}),r.$placeholder.insertAfter(g),a.length||o.addClass(r.settings.noChildClass)}}}}(this),this.$el.find("ul").not(":has(li)").remove()},_initStart:function(e){this.$li=t(e.target).closest("li"),this.childLevels=this._getChildLevels(this.$li),this.startPosition={x:e.pageX,y:e.pageY},this.startDepth=this.$li.parents("ul").length-1;var s=this.$li.offset();this.liOffset={x:this.startPosition.x-s.left,y:this.startPosition.y-s.top}},_initClone:function(){this.$clone=this.$li.clone(),this.$clone.css({display:"list-item",width:this.$li.outerWidth(),height:this.$li.outerHeight(),position:"absolute",zIndex:1e4,opacity:this.settings.opacity}),this.$li.parent().append(this.$clone)},_initPlaceholder:function(){this.placeholderHeight=this.$li.innerHeight(),this.$placeholder=t("<li></li>"),this.$placeholder.addClass(this.settings.placeholder).css({height:this.placeholderHeight}),this.$li.after(this.$placeholder)},_updateClonePosition:function(t){this.$clone.css({left:t.pageX-this.liOffset.x,top:t.pageY-this.liOffset.y})},_updateDelta:function(t){this.delta.x=-(this.startPosition.x-t.pageX),this.delta.y=this.startPosition.y-t.pageY},_updateTargetDepth:function(){var t=parseInt(this.delta.x/this.settings.tabWidth),e=this.startDepth+t;e=Math.max(e,0),e=Math.min(e,this.settings.maxDepth),e=Math.min(e,this.settings.maxDepth-this.childLevels),this.targetDepth=e},_getChildLevels:function(e,s){var i=0;return s=s||0,e.children("ul").children("li").each(t.proxy(function(e,l){i=Math.max(this._getChildLevels(t(l),s+1),i)},this)),s?i+1:i},_scroll:function(i){var l=this.$scrollParent[0],n=this.$scrollParent.offset();if(l!=e&&"HTML"!=l.tagName)n.top+l.offsetHeight-i.pageY<this.settings.scrollSensitivity?l.scrollTop=l.scrollTop+this.settings.scrollSpeed:i.pageY-n.top<this.settings.scrollSensitivity&&(l.scrollTop=l.scrollTop-this.settings.scrollSpeed),n.left+l.offsetWidth-i.pageX<this.settings.scrollSensitivity?l.scrollLeft=l.scrollLeft+this.settings.scrollSpeed:i.pageX-n.left<this.settings.scrollSensitivity&&(l.scrollLeft=l.scrollLeft-this.settings.scrollSpeed);else{var r=t(e),h=t(s);i.pageY-r.scrollTop()<this.settings.scrollSensitivity?r.scrollTop(r.scrollTop()-this.settings.scrollSpeed):h.height()-(i.pageY-r.scrollTop())<this.settings.scrollSensitivity&&r.scrollTop(r.scrollTop()+this.settings.scrollSpeed),i.pageX-r.scrollLeft()<this.settings.scrollSensitivity?r.scrollLeft(r.scrollLeft()-this.settings.scrollSpeed):h.width()-(i.pageX-r.scrollLeft())<this.settings.scrollSensitivity&&r.scrollLeft(r.scrollLeft()+this.settings.scrollSpeed)}},_yIntersectsPlaceholder:function(t){var e=this.$placeholder.offset().top,s=e+this.placeholderHeight;return t.pageY>=e&&t.pageY<=s},_trigger:function(e,s){this.$el.trigger(e,{event:s,toArray:t.proxy(this.toArray,this),serialize:t.proxy(this.serialize,this)})},_recursiveArray:function(e,s,i){var l,n,r=this,h=i+1,o=e.find("> ul > li"),a={};return o.length&&(s++,o.each(function(){h=r._recursiveArray(t(this),s,h)}),s--),l=e.attr(r.settings.dataAttribute),n=1===s?0:e.parent().parent().attr(r.settings.dataAttribute),l&&(a={id:l,parent_id:n,depth:s},a[this.settings.leftKey]=i,a[this.settings.rightKey]=h,this._results.push(a)),i=h+1},serialize:function(){for(var t=this.toArray(),e=[],s=0,i=t.length;i>s;s++){var l=t[s],n=this.settings.serializeKey+"["+s+"]";for(var r in l)l.hasOwnProperty(r)&&e.push(n+"["+r+"]="+l[r])}return e.join("&")},toArray:function(){var e=1,s=this;return this._results=[],this.$el.children("li").each(function(){e=s._recursiveArray(t(this),1,e)}),this._results=this._results.sort(function(t,e){return t.left-e.left}),this._results}},t.fn.nSortable=function(e){if(!e||"object"==typeof e)return this.each(function(){t(this).data("nSortable")||t(this).data("nSortable",new i(this,e))});if("string"==typeof e&&"_"!==e.charAt(0)){var s=this.data("nSortable");if(!s)throw new Error("nSortable is not initialized on this DOM element.");if(s&&s[e])return s[e].apply(s,Array.prototype.slice.apply(arguments,[1]))}throw new Error('"'+e+'" is no valid api method.')},t.fn.nSortable.defaults={handle:"div",tabWidth:20,containerElement:"> div",opacity:.6,placeholder:"placeholder",noChildClass:"no-children",dataAttribute:"data-node-id",maxDepth:1/0,animateTarget:!0,animationLength:300,scroll:!0,scrollSensitivity:20,scrollSpeed:20,serializeKey:"nodes",leftKey:"left",rightKey:"right"}}(jQuery,document,window);